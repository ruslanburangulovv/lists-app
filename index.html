<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ITS Work Watch ‚Äî –°–ø–∏—Å–∫–∏</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --brand-blue:#0047BB;
      --brand-teal:#00C5B5;
    }
    body { -webkit-tap-highlight-color: transparent; }
    .table-scroll { -webkit-overflow-scrolling: touch; }
    thead th { position: sticky; top: 0; z-index: 30; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 h-screen overflow-hidden">

<header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-slate-200">
  <div class="max-w-6xl mx-auto px-3 sm:px-4">
    <div class="h-14 flex items-center gap-3">
      <div class="text-lg font-bold" style="color:var(--brand-blue)">
        ITS Work Watch
      </div>
      <div class="flex-1"></div>
      <div class="md:hidden text-xl">‚ò∞</div>
    </div>

    <div class="pb-3 space-y-2">
      <div class="grid grid-cols-4 gap-1.5">
        <button id="tab1" class="h-10 rounded-xl text-[10px] sm:text-xs font-semibold border">–ì—Ä. 1</button>
        <button id="tab2" class="h-10 rounded-xl text-[10px] sm:text-xs font-semibold border">–ì—Ä. 2</button>
        <button id="tab3" class="h-10 rounded-xl text-[10px] sm:text-xs font-semibold border">–ù–æ—á—å</button>
        <button id="tab4" class="h-10 rounded-xl text-[10px] sm:text-xs font-semibold border">–ì—Ä. 4</button>
      </div>

      <div class="flex gap-2 items-center">
        <input
          id="search"
          type="number"
          inputmode="numeric"
          placeholder="–ü–æ–∏—Å–∫ –ø–æ ‚Ññ–º–µ—Ç–∫–∏..."
          class="min-w-0 flex-1 h-9 px-3 rounded-xl border border-slate-200 focus:ring-4 focus:ring-blue-100 text-sm"
        />
        <button
          id="columnsBtn"
          class="h-9 px-3 sm:px-4 rounded-xl border border-slate-200 text-sm font-semibold bg-white whitespace-nowrap"
          title="–í—ã–±–æ—Ä –∫–æ–ª–æ–Ω–æ–∫"
        >
          –ö–æ–ª–æ–Ω–∫–∏
        </button>
        <button
          id="refreshBtn"
          class="h-9 px-3 sm:px-4 rounded-xl border border-slate-200 text-sm font-semibold whitespace-nowrap"
        >
          –û–±–Ω–æ–≤–∏—Ç—å
        </button>
      </div>

      <div class="text-xs text-slate-500">
        –ü–æ–∏—Å–∫ –ø–æ ‚Äú‚Ññ–º–µ—Ç–∫–∏‚Äù. –ö–æ–ª–æ–Ω–∫–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫.
      </div>

      <div id="hint" class="hidden text-xs text-slate-500"></div>
      <div id="status" class="hidden rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700"></div>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-3 sm:px-4 py-3 h-[calc(100vh-16.5rem)]">
  <div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden h-full">
    <div id="tableScroll" class="table-scroll overflow-auto h-full">
      <table class="min-w-full text-sm">
        <thead id="thead" class="bg-slate-50"></thead>
        <tbody id="tbody" class="divide-y divide-slate-100"></tbody>
      </table>
    </div>
  </div>
</main>

<div id="modal" class="hidden fixed inset-0 z-50">
  <div id="modalBackdrop" class="absolute inset-0 bg-black/40"></div>
  <div class="relative mx-auto max-w-lg px-3 sm:px-4 mt-6">
    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
      <div class="px-4 py-3 border-b border-slate-200 flex items-center gap-3">
        <div class="font-semibold">–í—ã–±–æ—Ä –∫–æ–ª–æ–Ω–æ–∫</div>
        <div class="flex-1"></div>
        <button id="closeModal" class="h-9 w-9 rounded-xl border border-slate-200 hover:bg-slate-50">‚úï</button>
      </div>
      <div class="px-4 py-3">
        <div class="flex gap-2 mb-3">
          <button id="selectAll" class="h-9 px-3 rounded-xl border border-slate-200 text-sm font-semibold hover:bg-slate-50">–í—Å–µ</button>
          <button id="selectMin" class="h-9 px-3 rounded-xl border border-slate-200 text-sm font-semibold hover:bg-slate-50">–¢–æ–ª—å–∫–æ ‚Ññ</button>
        </div>
        <div id="colsList" class="max-h-[55vh] overflow-auto pr-1 space-y-2"></div>
      </div>
      <div class="px-4 py-3 border-t border-slate-200 flex items-center gap-2">
        <button id="applyCols" class="h-10 px-4 rounded-xl text-white text-sm font-semibold" style="background:var(--brand-blue)">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button id="cancelCols" class="h-10 px-4 rounded-xl border border-slate-200 text-sm font-semibold">–û—Ç–º–µ–Ω–∞</button>
        <div class="flex-1"></div>
        <div class="text-xs text-slate-500" id="colsCounter"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // =======================
  // Google Sheet Configuration
  // =======================
  const SHEET_ID = "1CU56AZdWC9dCvkf_z6CWMtrgfuWRCG3HYx7hp79vI_c";
  const SHEET_NAME = "–î–ª—è –ø–µ—á–∞—Ç–∏üñ®Ô∏è";
  const STATUS_SHEET_NAME = "–°–≤–æ–¥_–∂—É—Ä–Ω–∞–ª–æ–≤_–°–ü–ì+–¢–°–ë";
  const STATUS_RANGE = "Q1:R2";

  const GROUPS = {
    1: "D2:M150",
    2: "R2:Z150",
    3: "AE2:AM150",
    4: "AR2:AZ150" // New Group 4
  };

  const TRIGGER_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzU7wYhYZxJu8_QvJMq174aPZ6lPeHu5PY6jqfyGbE1QgxZv0KwFVvgsDt_A2-wXUWA/exec";
  const TRIGGER_TOKEN = "12345";

  const STATUS_COL_NAME = "–°—Ç–∞—Ç—É—Å –æ–±—Ö–æ–¥–∞";
  const STATUS_WAIT = "–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö";
  const STATUS_DONE = "–î–∞–Ω–Ω—ã–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã";

  const POLL_INTERVAL_MS = 2000;
  const START_TIMEOUT_MS = 10000;
  let pollTimer = null;
  let pollStartedAt = 0;
  let pollStage = "idle";

  // State
  let currentGroup = 1;
  let headers = [];
  let rows = [];
  let labelIndex = -1;
  let walkStatusIndex = -1;
  let visibleCols = new Set();
  let draftVisibleCols = new Set();

  const labelCounts = {
    1: { total: 0, done: 0 },
    2: { total: 0, done: 0 },
    3: { total: 0, done: 0 },
    4: { total: 0, done: 0 }
  };

  // UI Elements
  const tab1 = document.getElementById("tab1");
  const tab2 = document.getElementById("tab2");
  const tab3 = document.getElementById("tab3");
  const tab4 = document.getElementById("tab4");
  const searchEl = document.getElementById("search");
  const refreshBtn = document.getElementById("refreshBtn");
  const columnsBtn = document.getElementById("columnsBtn");
  const thead = document.getElementById("thead");
  const tbody = document.getElementById("tbody");
  const hintEl = document.getElementById("hint");
  const tableScroll = document.getElementById("tableScroll");
  const statusEl = document.getElementById("status");
  const modal = document.getElementById("modal");
  const modalBackdrop = document.getElementById("modalBackdrop");
  const closeModal = document.getElementById("closeModal");
  const colsList = document.getElementById("colsList");
  const applyCols = document.getElementById("applyCols");
  const cancelCols = document.getElementById("cancelCols");
  const selectAll = document.getElementById("selectAll");
  const selectMin = document.getElementById("selectMin");
  const colsCounter = document.getElementById("colsCounter");

  // Helpers
  function setStatusBoxHtml(html){
    if (!html) { statusEl.classList.add("hidden"); statusEl.innerHTML = ""; return; }
    statusEl.classList.remove("hidden");
    statusEl.innerHTML = html;
  }

  function setHint(text){
    if (!text) { hintEl.classList.add("hidden"); hintEl.textContent = ""; return; }
    hintEl.classList.remove("hidden");
    hintEl.textContent = text;
  }

  function norm(s){ return String(s ?? "").toLowerCase().replace(/\s/g, "").replace(/\u00A0/g, ""); }
  function cellText(v){ return (v === null || v === undefined || v === true || v === false) ? "" : String(v); }
  function isIntLike(s){ return /^[0-9]+$/.test(String(s ?? "").trim()); }
  function escapeHtml(str) {
    return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
  }

  function computeLabelCount(){
    if (labelIndex === -1) return 0;
    return rows.filter(r => isIntLike(r[labelIndex])).length;
  }

  function computeDoneCount(){
    if (walkStatusIndex === -1) return 0;
    return rows.filter(r => String(r[walkStatusIndex] ?? "").trim() === STATUS_DONE).length;
  }

  function applyTabs(active){
    const buttons = [tab1, tab2, tab3, tab4];
    const baseNames = ["–ì—Ä. 1", "–ì—Ä. 2", "–ù–æ—á—å", "–ì—Ä. 4"];
    
    buttons.forEach((b, i) => {
      const group = i + 1;
      const info = labelCounts[group] || { total: 0, done: 0 };
      b.textContent = `${baseNames[i]} (${info.done}/${info.total})`;

      if(group === active){
        b.style.background = "var(--brand-blue)";
        b.style.color = "white";
        b.classList.add("border-transparent");
      } else {
        b.style.background = "";
        b.style.color = "";
        b.classList.remove("border-transparent");
      }
    });
  }

  function detectLabelIndex() {
    let idx = headers.findIndex(h => norm(h) === norm("‚Ññ–º–µ—Ç–∫–∏"));
    if (idx === -1) {
      idx = headers.findIndex(h => {
        const nh = norm(h);
        return nh.includes("–º–µ—Ç–∫") && (nh.includes("‚Ññ") || nh.includes("no") || nh.includes("–Ω–æ–º–µ—Ä"));
      });
    }
    if (idx === -1 && rows.length) {
      const colCount = headers.length || rows[0].length;
      const scores = new Array(colCount).fill(0);
      rows.forEach(r => {
        for (let c = 0; c < colCount; c++) if (isIntLike(cellText(r[c]))) scores[c]++;
      });
      let best = -1, max = 0;
      scores.forEach((s, i) => { if(s > max) { max = s; best = i; } });
      if (best !== -1 && max >= 3) idx = best;
    }
    labelIndex = idx;
    setHint(labelIndex !== -1 ? `–ö–æ–ª–æ–Ω–∫–∞ ‚Ññ–º–µ—Ç–∫–∏: ${labelIndex + 1} (‚Äú${headers[labelIndex]}‚Äù)` : '–ö–æ–ª–æ–Ω–∫–∞ ‚Äú‚Ññ–º–µ—Ç–∫–∏‚Äù –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
  }

  function detectWalkStatusIndex() { walkStatusIndex = headers.findIndex(h => norm(h) === norm(STATUS_COL_NAME)); }

  function sortRowsByWalkStatus() {
    if (walkStatusIndex === -1) return;
    const rank = (v) => {
      const s = String(v ?? "").trim();
      return s === STATUS_WAIT ? 0 : (s === STATUS_DONE ? 1 : 2);
    };
    rows.sort((a, b) => rank(a[walkStatusIndex]) - rank(b[walkStatusIndex]));
  }

  function storageKey() { return `itsww_v10_g${currentGroup}_${headers.map(h => norm(h)).join("|")}`; }

  function loadVisibleColsFromStorage() {
    const colCount = headers.length;
    const all = new Set(Array.from({length: colCount}, (_,i)=>i));
    try {
      const arr = JSON.parse(localStorage.getItem(storageKey()));
      visibleCols = (Array.isArray(arr)) ? new Set(arr.filter(n => n >= 0 && n < colCount)) : all;
      if (labelIndex !== -1) visibleCols.add(labelIndex);
    } catch { visibleCols = all; }
  }

  function saveVisibleColsToStorage() { localStorage.setItem(storageKey(), JSON.stringify(Array.from(visibleCols))); }

  async function fetchStatusRaw(){
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(STATUS_SHEET_NAME)}&range=${encodeURIComponent(STATUS_RANGE)}&headers=0&t=${Date.now()}`;
    const res = await fetch(url);
    const text = await res.text();
    const json = JSON.parse(text.substring(47).slice(0,-2));
    const vals = (json.table.rows || []).map(r => (r.c || []).map(c => cellText(c ? c.v : "")));
    const lines = vals.map(row => row.map(x => x.trim()).filter(Boolean).join(" ")).filter(Boolean);
    const html = lines.length ? `<div class="flex items-start gap-2"><div class="mt-0.5 h-2.5 w-2.5 rounded-full" style="background:var(--brand-teal)"></div><div class="leading-5">${lines.map(l => `<div>${escapeHtml(l)}</div>`).join("")}</div></div>` : "";
    return { raw: lines.join(" | "), html };
  }

  async function loadStatusBox(){
    try { const { raw, html } = await fetchStatusRaw(); setStatusBoxHtml(html); return raw; }
    catch { setStatusBoxHtml(""); return ""; }
  }

  async function loadGroup(n){
    currentGroup = n;
    applyTabs(n);
    searchEl.value = "";
    tableScroll.scrollTop = 0;
    loadStatusBox();
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&range=${encodeURIComponent(GROUPS[n])}&headers=1&t=${Date.now()}`;
    try{
      const res = await fetch(url);
      const text = await res.text();
      const json = JSON.parse(text.substring(47).slice(0,-2));
      headers = json.table.cols.map(c => cellText(c.label || ""));
      rows = json.table.rows.map(r => (r.c || []).map(c => cellText(c ? c.v : "")));
      detectLabelIndex(); detectWalkStatusIndex(); sortRowsByWalkStatus();
      labelCounts[currentGroup] = { total: computeLabelCount(), done: computeDoneCount() };
      applyTabs(currentGroup);
      loadVisibleColsFromStorage(); renderFiltered();
    } catch (e) {
      tbody.innerHTML = `<tr><td class="px-3 py-10 text-center text-red-500 font-bold">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
    }
  }

  function renderFiltered(){
    const q = searchEl.value.trim();
    renderTable((q && labelIndex !== -1) ? rows.filter(r => String(r[labelIndex] ?? "").trim() === q) : rows);
  }

  function renderTable(data){
    const colIdx = Array.from({length: headers.length}, (_, i) => i).filter(i => visibleCols.has(i));
    if (labelIndex !== -1 && !colIdx.includes(labelIndex)) colIdx.unshift(labelIndex);

    thead.innerHTML = `<tr>${colIdx.map(i=>`<th class="px-3 py-3 text-left font-semibold border-b whitespace-nowrap bg-slate-100">${escapeHtml(headers[i] || "‚Äî")}</th>`).join("")}</tr>`;
    
    if (!data.length) {
      tbody.innerHTML = `<tr><td colspan="${colIdx.length || 1}" class="px-3 py-10 text-center text-slate-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
      return;
    }

    tbody.innerHTML = data.map((row, rIdx)=> {
      const isDone = (walkStatusIndex !== -1 && String(row[walkStatusIndex] ?? "").trim() === STATUS_DONE);
      return `<tr class="${isDone ? "bg-emerald-50" : (rIdx%2 ? "bg-slate-50" : "")}">
        ${colIdx.map(i=>`<td class="px-3 py-3 whitespace-nowrap">${escapeHtml(row[i] ?? "")}</td>`).join("")}
      </tr>`;
    }).join("");
  }

  // Modal logic
  function openModal(){ draftVisibleCols = new Set(visibleCols); renderColsList(); modal.classList.remove("hidden"); }
  function closeModalUI(){ modal.classList.add("hidden"); }
  function renderColsList(){
    colsList.innerHTML = headers.map((name, i) => {
      const isLocked = (i === labelIndex && labelIndex !== -1);
      return `<label class="flex items-center gap-3 p-2 rounded-xl border border-slate-200 hover:bg-slate-50">
        <input type="checkbox" class="h-4 w-4" ${draftVisibleCols.has(i) ? "checked":""} ${isLocked ? "disabled":""} onchange="toggleDraftCol(${i}, this.checked)"/>
        <div class="flex-1 text-sm font-semibold">${escapeHtml(name || '–ö–æ–ª–æ–Ω–∫–∞ '+(i+1))}</div>
      </label>`;
    }).join("");
    updateCounter();
  }
  window.toggleDraftCol = (i, checked) => {
    if (checked) draftVisibleCols.add(i); else draftVisibleCols.delete(i);
    if (labelIndex !== -1) draftVisibleCols.add(labelIndex);
    updateCounter();
  };
  function updateCounter(){ colsCounter.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${draftVisibleCols.size}`; }

  // Polling logic
  function stopPolling(){ clearInterval(pollTimer); pollTimer = null; refreshBtn.disabled = false; refreshBtn.textContent = "–û–±–Ω–æ–≤–∏—Ç—å"; }
  async function pollTick(){
    const raw = await loadStatusBox();
    const isUpd = raw.toLowerCase().includes("–∏–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ");
    if (pollStage === "waitingStart" && isUpd) pollStage = "waitingFinish";
    else if (pollStage === "waitingFinish" && !isUpd && /\d{2}:\d{2}:\d{2}/.test(raw)) {
      stopPolling(); loadGroup(currentGroup);
    } else if (Date.now() - pollStartedAt > START_TIMEOUT_MS) stopPolling();
  }

  // Bind Events
  tab1.onclick = () => loadGroup(1);
  tab2.onclick = () => loadGroup(2);
  tab3.onclick = () => loadGroup(3);
  tab4.onclick = () => loadGroup(4);
  searchEl.oninput = renderFiltered;
  refreshBtn.onclick = async () => {
    stopPolling(); refreshBtn.disabled = true; refreshBtn.textContent = "‚Ä¶";
    (new Image()).src = `${TRIGGER_WEBAPP_URL}?token=${encodeURIComponent(TRIGGER_TOKEN)}&t=${Date.now()}`;
    pollStartedAt = Date.now(); pollStage = "waitingStart"; pollTimer = setInterval(pollTick, POLL_INTERVAL_MS);
  };
  columnsBtn.onclick = openModal;
  modalBackdrop.onclick = closeModalUI;
  closeModal.onclick = closeModalUI;
  cancelCols.onclick = closeModalUI;
  applyCols.onclick = () => { visibleCols = new Set(draftVisibleCols); saveVisibleColsToStorage(); closeModalUI(); renderFiltered(); };
  selectAll.onclick = () => { headers.forEach((_,i)=>draftVisibleCols.add(i)); renderColsList(); };
  selectMin.onclick = () => { draftVisibleCols.clear(); if(labelIndex!==-1) draftVisibleCols.add(labelIndex); renderColsList(); };

  // Init
  loadGroup(1);
</script>
</body>
</html>
