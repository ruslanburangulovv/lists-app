<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ITS Work Watch ‚Äî –°–ø–∏—Å–∫–∏</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --brand-blue:#0047BB;
      --brand-teal:#00C5B5;
    }
    body { -webkit-tap-highlight-color: transparent; }
    .table-scroll { -webkit-overflow-scrolling: touch; }
    thead th { position: sticky; top: 0; z-index: 30; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 h-screen overflow-hidden">

<header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-slate-200">
  <div class="max-w-6xl mx-auto px-3 sm:px-4">
    <div class="h-14 flex items-center gap-3">
      <div class="text-lg font-bold" style="color:var(--brand-blue)">
        ITS Work Watch
      </div>
      <div class="flex-1"></div>
      <div class="md:hidden text-xl">‚ò∞</div>
    </div>

    <div class="pb-3 space-y-2">
      <!-- Tabs -->
      <div class="grid grid-cols-3 gap-2">
        <button id="tab1" class="h-10 rounded-xl text-sm font-semibold border">–ì—Ä—É–ø–ø–∞ 1</button>
        <button id="tab2" class="h-10 rounded-xl text-sm font-semibold border">–ì—Ä—É–ø–ø–∞ 2</button>
        <button id="tab3" class="h-10 rounded-xl text-sm font-semibold border">–ù–æ—á—å</button>
      </div>

      <!-- Search + buttons -->
      <div class="flex gap-2 items-center">
        <input
          id="search"
          type="number"
          inputmode="numeric"
          placeholder="–ü–æ–∏—Å–∫ –ø–æ ‚Ññ–º–µ—Ç–∫–∏..."
          class="min-w-0 flex-1 h-9 px-3 rounded-xl border border-slate-200 focus:ring-4 focus:ring-blue-100 text-sm"
        />
        <button
          id="columnsBtn"
          class="h-9 px-3 sm:px-4 rounded-xl border border-slate-200 text-sm font-semibold bg-white whitespace-nowrap"
          title="–í—ã–±–æ—Ä –∫–æ–ª–æ–Ω–æ–∫"
        >
          –ö–æ–ª–æ–Ω–∫–∏
        </button>
        <button
          id="refreshBtn"
          class="h-9 px-3 sm:px-4 rounded-xl border border-slate-200 text-sm font-semibold whitespace-nowrap"
        >
          –û–±–Ω–æ–≤–∏—Ç—å
        </button>
      </div>

      <div class="text-xs text-slate-500">
        –ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ –∫–æ–ª–æ–Ω–∫–µ ‚Äú‚Ññ–º–µ—Ç–∫–∏‚Äù. –ö–æ–ª–æ–Ω–∫–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–π –≤–∫–ª–∞–¥–∫–∏.
      </div>

      <div id="hint" class="hidden text-xs text-slate-500"></div>

      <!-- Live status from Q1:R2 -->
      <div id="status" class="hidden rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700"></div>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-3 sm:px-4 py-3 h-[calc(100vh-16.0rem)]">
  <div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden h-full">
    <div id="tableScroll" class="table-scroll overflow-auto h-full">
      <table class="min-w-full text-sm">
        <thead id="thead" class="bg-slate-50"></thead>
        <tbody id="tbody" class="divide-y divide-slate-100"></tbody>
      </table>
    </div>
  </div>
</main>

<!-- Columns modal -->
<div id="modal" class="hidden fixed inset-0 z-50">
  <div id="modalBackdrop" class="absolute inset-0 bg-black/40"></div>

  <div class="relative mx-auto max-w-lg px-3 sm:px-4 mt-6">
    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
      <div class="px-4 py-3 border-b border-slate-200 flex items-center gap-3">
        <div class="font-semibold">–í—ã–±–æ—Ä –∫–æ–ª–æ–Ω–æ–∫ (—Ç–µ–∫—É—â–∞—è –≥—Ä—É–ø–ø–∞)</div>
        <div class="flex-1"></div>
        <button id="closeModal" class="h-9 w-9 rounded-xl border border-slate-200 hover:bg-slate-50">‚úï</button>
      </div>

      <div class="px-4 py-3">
        <div class="text-xs text-slate-500 mb-2">
          ‚Äú‚Ññ–º–µ—Ç–∫–∏‚Äù –≤—Å–µ–≥–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è.
        </div>

        <div class="flex gap-2 mb-3">
          <button id="selectAll" class="h-9 px-3 rounded-xl border border-slate-200 text-sm font-semibold hover:bg-slate-50">
            –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ
          </button>
          <button id="selectMin" class="h-9 px-3 rounded-xl border border-slate-200 text-sm font-semibold hover:bg-slate-50">
            –¢–æ–ª—å–∫–æ ‚Ññ–º–µ—Ç–∫–∏
          </button>
        </div>

        <div id="colsList" class="max-h-[55vh] overflow-auto pr-1 space-y-2"></div>
      </div>

      <div class="px-4 py-3 border-t border-slate-200 flex items-center gap-2">
        <button id="applyCols" class="h-10 px-4 rounded-xl text-white text-sm font-semibold"
                style="background:var(--brand-blue)">
          –ü—Ä–∏–º–µ–Ω–∏—Ç—å
        </button>
        <button id="cancelCols" class="h-10 px-4 rounded-xl border border-slate-200 text-sm font-semibold">
          –û—Ç–º–µ–Ω–∞
        </button>
        <div class="flex-1"></div>
        <div class="text-xs text-slate-500" id="colsCounter"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // =======================
  // Google Sheet
  // =======================
  const SHEET_ID = "1CU56AZdWC9dCvkf_z6CWMtrgfuWRCG3HYx7hp79vI_c";
  const SHEET_NAME = "–î–ª—è –ø–µ—á–∞—Ç–∏üñ®Ô∏è";

  // Status sheet
  const STATUS_SHEET_NAME = "–°–≤–æ–¥_–∂—É—Ä–Ω–∞–ª–æ–≤_–°–ü–ì+–¢–°–ë";
  const STATUS_RANGE = "Q1:R2";

  // Groups ranges
  const GROUPS = {
    1: "D2:M150",
    2: "R2:Z150",
    3: "AE2:AM150"
  };

  // =======================
  // Apps Script Web App
  // =======================
  const TRIGGER_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzU7wYhYZxJu8_QvJMq174aPZ6lPeHu5PY6jqfyGbE1QgxZv0KwFVvgsDt_A2-wXUWA/exec";
  const TRIGGER_TOKEN = "12345";

  // =======================
  // Sorting & highlight
  // =======================
  const STATUS_COL_NAME = "–°—Ç–∞—Ç—É—Å –æ–±—Ö–æ–¥–∞";
  const STATUS_WAIT = "–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö";
  const STATUS_DONE = "–î–∞–Ω–Ω—ã–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã";

  // =======================
  // Two-stage status check
  // =======================
  const POLL_INTERVAL_MS = 2000;   // –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫
  const START_TIMEOUT_MS = 10000;  // 10 —Å–µ–∫ –Ω–∞ —Å—Ç–∞—Ä—Ç
  let pollTimer = null;
  let pollStartedAt = 0;
  let pollStage = "idle"; // "waitingStart" | "waitingFinish" | "idle"

  // =======================
  // State
  // =======================
  let currentGroup = 1;
  let headers = [];
  let rows = [];
  let labelIndex = -1;
  let walkStatusIndex = -1;

  let visibleCols = new Set();
  let draftVisibleCols = new Set();

  // tabs: done/total
  const labelCounts = {
    1: { total: 0, done: 0 },
    2: { total: 0, done: 0 },
    3: { total: 0, done: 0 }
  };

  // =======================
  // UI
  // =======================
  const tab1 = document.getElementById("tab1");
  const tab2 = document.getElementById("tab2");
  const tab3 = document.getElementById("tab3");
  const searchEl = document.getElementById("search");
  const refreshBtn = document.getElementById("refreshBtn");
  const columnsBtn = document.getElementById("columnsBtn");
  const thead = document.getElementById("thead");
  const tbody = document.getElementById("tbody");
  const hintEl = document.getElementById("hint");
  const tableScroll = document.getElementById("tableScroll");
  const statusEl = document.getElementById("status");

  const modal = document.getElementById("modal");
  const modalBackdrop = document.getElementById("modalBackdrop");
  const closeModal = document.getElementById("closeModal");
  const colsList = document.getElementById("colsList");
  const applyCols = document.getElementById("applyCols");
  const cancelCols = document.getElementById("cancelCols");
  const selectAll = document.getElementById("selectAll");
  const selectMin = document.getElementById("selectMin");
  const colsCounter = document.getElementById("colsCounter");

  // =======================
  // Helpers
  // =======================
  function setStatusBoxHtml(html){
    if (!html) {
      statusEl.classList.add("hidden");
      statusEl.innerHTML = "";
      return;
    }
    statusEl.classList.remove("hidden");
    statusEl.innerHTML = html;
  }

  function setHint(text){
    if (!text) { hintEl.classList.add("hidden"); hintEl.textContent = ""; return; }
    hintEl.classList.remove("hidden");
    hintEl.textContent = text;
  }

  function norm(s){
    return String(s ?? "")
      .toLowerCase()
      .replaceAll(" ", "")
      .replaceAll("\u00A0","");
  }

  function cellText(v){
    if (v === true || v === false) return "";
    if (v === null || v === undefined) return "";
    return String(v);
  }

  function isIntLike(s){
    const t = String(s ?? "").trim();
    return /^[0-9]+$/.test(t);
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function computeLabelCount(){
    if (labelIndex === -1) return 0;
    let cnt = 0;
    for (const r of rows) {
      if (isIntLike(r[labelIndex])) cnt++;
    }
    return cnt;
  }

  function computeDoneCount(){
    if (walkStatusIndex === -1) return 0;
    let cnt = 0;
    for (const r of rows) {
      if (String(r[walkStatusIndex] ?? "").trim() === STATUS_DONE) cnt++;
    }
    return cnt;
  }

  function applyTabs(active){
    const buttons = [tab1, tab2, tab3];
    buttons.forEach((b,i)=>{
      const group = i + 1;
      const info = labelCounts[group] || { total:0, done:0 };
      const baseName = group === 1 ? "–ì—Ä—É–ø–ø–∞ 1" : (group === 2 ? "–ì—Ä—É–ø–ø–∞ 2" : "–ù–æ—á—å");
      b.textContent = `${baseName} (${info.done} / ${info.total})`;

      if(group===active){
        b.style.background = "var(--brand-blue)";
        b.style.color = "white";
        b.classList.add("border-transparent");
      } else {
        b.style.background = "";
        b.style.color = "";
        b.classList.remove("border-transparent");
      }
    });
  }

  function detectLabelIndex() {
    const target = norm("‚Ññ–º–µ—Ç–∫–∏");
    let idx = headers.findIndex(h => norm(h) === target);

    if (idx === -1) {
      idx = headers.findIndex(h => {
        const nh = norm(h);
        return nh.includes("–º–µ—Ç–∫") && (nh.includes("‚Ññ") || nh.includes("no") || nh.includes("–Ω–æ–º–µ—Ä"));
      });
    }

    if (idx === -1 && rows.length) {
      const colCount = headers.length || (rows[0] ? rows[0].length : 0);
      const scores = new Array(colCount).fill(0);

      for (const r of rows) {
        for (let c = 0; c < colCount; c++) {
          const v = cellText(r[c]);
          if (isIntLike(v)) scores[c] += 1;
        }
      }

      let best = -1, bestScore = 0;
      for (let c = 0; c < scores.length; c++) {
        if (scores[c] > bestScore) { bestScore = scores[c]; best = c; }
      }
      if (best !== -1 && bestScore >= 3) idx = best;
    }

    labelIndex = idx;

    if (labelIndex !== -1) {
      const headerName = headers[labelIndex] ? ` (‚Äú${headers[labelIndex]}‚Äù)` : "";
      setHint(`–ö–æ–ª–æ–Ω–∫–∞ ‚Ññ–º–µ—Ç–∫–∏: ${labelIndex + 1}${headerName}`);
    } else {
      setHint('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É ‚Äú‚Ññ–º–µ—Ç–∫–∏‚Äù.');
    }
  }

  function detectWalkStatusIndex() {
    const t = norm(STATUS_COL_NAME);
    walkStatusIndex = headers.findIndex(h => norm(h) === t);
  }

  function sortRowsByWalkStatus() {
    if (walkStatusIndex === -1) return;

    const rank = (v) => {
      const s = String(v ?? "").trim();
      if (s === STATUS_WAIT) return 0;
      if (s === STATUS_DONE) return 1;
      return 2;
    };

    rows = rows
      .map((r, i) => ({ r, i }))
      .sort((a, b) => {
        const ra = rank(a.r[walkStatusIndex]);
        const rb = rank(b.r[walkStatusIndex]);
        if (ra !== rb) return ra - rb;
        return a.i - b.i;
      })
      .map(x => x.r);
  }

  // =======================
  // Columns (per-group)
  // =======================
  function storageKey() {
    const signature = headers.map(h => norm(h)).join("|");
    return `itsww_visibleCols_v9_group_${currentGroup}_${signature}`;
  }

  function loadVisibleColsFromStorage() {
    const colCount = headers.length || 0;
    const all = new Set(Array.from({length: colCount}, (_,i)=>i));
    if (labelIndex !== -1) all.add(labelIndex);

    try {
      const raw = localStorage.getItem(storageKey());
      if (!raw) { visibleCols = all; return; }

      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) { visibleCols = all; return; }

      const set = new Set(arr.filter(n => Number.isInteger(n) && n >= 0 && n < colCount));
      if (labelIndex !== -1) set.add(labelIndex);
      if (set.size === 0 && labelIndex !== -1) set.add(labelIndex);
      visibleCols = set;
    } catch {
      visibleCols = all;
    }
  }

  function saveVisibleColsToStorage() {
    try {
      localStorage.setItem(storageKey(), JSON.stringify(Array.from(visibleCols)));
    } catch {}
  }

  function getVisibleColIndices() {
    const res = [];
    for (let i=0; i<headers.length; i++) {
      if (visibleCols.has(i)) res.push(i);
    }
    if (labelIndex !== -1 && !res.includes(labelIndex)) res.unshift(labelIndex);
    return res;
  }

  // =======================
  // Status loader (Q1:R2)
  // =======================
  function isUpdating(raw){
    return String(raw || "").toLowerCase().includes("–∏–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ");
  }
  function hasTime(raw){
    return /\b\d{2}\.\d{2}\.\d{4}\s+\d{2}:\d{2}:\d{2}\b/.test(String(raw || ""));
  }

  async function fetchStatusRaw(){
    const url =
      `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?` +
      `sheet=${encodeURIComponent(STATUS_SHEET_NAME)}&range=${encodeURIComponent(STATUS_RANGE)}&headers=0&t=${Date.now()}`;

    const res = await fetch(url);
    const text = await res.text();
    const json = JSON.parse(text.substring(47).slice(0,-2));
    const table = json.table;

    const vals = (table.rows || []).map(r => (r.c || []).map(c => cellText(c ? c.v : "")));

    const raw = vals
      .flat()
      .map(x => String(x || "").trim())
      .filter(Boolean)
      .join(" | ");

    const lines = [];
    for (const row of vals) {
      const line = row.map(x => String(x || "").trim()).filter(Boolean).join(" ");
      if (line) lines.push(line);
    }

    const html = lines.length
      ? `
        <div class="flex items-start gap-2">
          <div class="mt-0.5 h-2.5 w-2.5 rounded-full" style="background:var(--brand-teal)"></div>
          <div class="leading-5">
            ${lines.map(l => `<div>${escapeHtml(l)}</div>`).join("")}
          </div>
        </div>`
      : "";

    return { raw, html };
  }

  async function loadStatusBox(){
    try {
      const { raw, html } = await fetchStatusRaw();
      setStatusBoxHtml(html);
      return raw;
    } catch {
      setStatusBoxHtml("");
      return "";
    }
  }

  // =======================
  // Data
  // =======================
  async function loadGroup(n){
    currentGroup = n;
    applyTabs(n);
    searchEl.value = "";
    tableScroll.scrollTop = 0;

    // –ø–æ–¥—Ç—è–Ω—É—Ç—å —Å—Ç–∞—Ç—É—Å
    loadStatusBox();

    const range = GROUPS[n];
    const url =
      `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?` +
      `sheet=${encodeURIComponent(SHEET_NAME)}&range=${encodeURIComponent(range)}&headers=1&t=${Date.now()}`;

    try{
      const res = await fetch(url);
      const text = await res.text();
      const json = JSON.parse(text.substring(47).slice(0,-2));
      const table = json.table;

      headers = table.cols.map(c => cellText(c.label || ""));
      rows = table.rows.map(r => (r.c || []).map(c => cellText(c ? c.v : "")));

      detectLabelIndex();
      detectWalkStatusIndex();
      sortRowsByWalkStatus();

      labelCounts[currentGroup] = {
        total: computeLabelCount(),
        done: computeDoneCount()
      };
      applyTabs(currentGroup);

      loadVisibleColsFromStorage();
      renderFiltered();
    } catch (e) {
      console.error(e);
      setStatusBoxHtml(`<div class="text-red-600 font-semibold">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>`);
      thead.innerHTML = "";
      tbody.innerHTML = `<tr><td class="px-3 py-10 text-center text-slate-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>`;
    }
  }

  function renderFiltered(){
    const q = String(searchEl.value || "").trim();
    let filtered = rows;

    if (q && labelIndex !== -1) {
      filtered = rows.filter(r => String(r[labelIndex] ?? "").trim() === q);
    }
    renderTable(filtered);
  }

  function renderTable(data){
    const colIdx = getVisibleColIndices();

    thead.innerHTML = `
      <tr>
        ${colIdx.map(i=>`
          <th class="px-3 py-3 text-left font-semibold border-b whitespace-nowrap bg-slate-100">
            ${escapeHtml(headers[i] || "‚Äî")}
          </th>`).join("")}
      </tr>
    `;

    if (!data.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="${Math.max(colIdx.length,1)}" class="px-3 py-10 text-center text-slate-500">
            –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
          </td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = data.map((row,rIdx)=> {
      const st = (walkStatusIndex !== -1) ? String(row[walkStatusIndex] ?? "").trim() : "";
      const isDone = (st === STATUS_DONE);

      const rowClass = isDone
        ? "bg-emerald-50"
        : (rIdx%2 ? "bg-slate-50" : "");

      const cellClass = "px-3 py-3 whitespace-nowrap";

      return `
        <tr class="${rowClass}">
          ${colIdx.map(i=>`
            <td class="${cellClass}">
              ${escapeHtml(row[i] ?? "")}
            </td>`).join("")}
        </tr>
      `;
    }).join("");
  }

  // =======================
  // Modal
  // =======================
  function openModal(){
    draftVisibleCols = new Set(visibleCols);
    if (labelIndex !== -1) draftVisibleCols.add(labelIndex);
    renderColsList();
    modal.classList.remove("hidden");
  }
  function closeModalUI(){ modal.classList.add("hidden"); }

  function renderColsList(){
    const colCount = headers.length;
    colsList.innerHTML = "";

    for (let i=0; i<colCount; i++){
      const name = headers[i] || `–ö–æ–ª–æ–Ω–∫–∞ ${i+1}`;
      const checked = draftVisibleCols.has(i);
      const isLocked = (i === labelIndex && labelIndex !== -1);

      const row = document.createElement("label");
      row.className = "flex items-center gap-3 p-2 rounded-xl border border-slate-200 hover:bg-slate-50";
      row.innerHTML = `
        <input type="checkbox" class="h-4 w-4" ${checked ? "checked":""} ${isLocked ? "disabled":""}/>
        <div class="flex-1">
          <div class="text-sm font-semibold text-slate-800">${escapeHtml(name)}</div>
          <div class="text-xs text-slate-500">–ö–æ–ª–æ–Ω–∫–∞ ${i+1}${isLocked ? " ‚Ä¢ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è":""}</div>
        </div>
      `;

      const cb = row.querySelector("input");
      cb.addEventListener("change", () => {
        if (cb.checked) draftVisibleCols.add(i);
        else draftVisibleCols.delete(i);
        if (labelIndex !== -1) draftVisibleCols.add(labelIndex);
        updateCounter();
      });

      colsList.appendChild(row);
    }

    updateCounter();
  }

  function updateCounter(){
    const colCount = headers.length || 0;
    colsCounter.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ: ${draftVisibleCols.size} –∏–∑ ${colCount}`;
  }

  function applyDraft(){
    visibleCols = new Set(draftVisibleCols);
    if (labelIndex !== -1) visibleCols.add(labelIndex);
    saveVisibleColsToStorage();
    closeModalUI();
    renderFiltered();
  }

  function showAllCols(){
    draftVisibleCols = new Set(Array.from({length: headers.length}, (_,i)=>i));
    if (labelIndex !== -1) draftVisibleCols.add(labelIndex);
    renderColsList();
  }

  function showOnlyLabel(){
    draftVisibleCols = new Set();
    if (labelIndex !== -1) draftVisibleCols.add(labelIndex);
    renderColsList();
  }

  // =======================
  // Trigger call (NO CORS)
  // =======================
  async function runTrigger(){
    if (!TRIGGER_WEBAPP_URL) return { ok:true, skipped:true };
    const url = `${TRIGGER_WEBAPP_URL}?token=${encodeURIComponent(TRIGGER_TOKEN)}&t=${Date.now()}`;
    (new Image()).src = url;
    return { ok:true };
  }

  // =======================
  // Two-stage polling logic
  // =======================
  function stopPolling(){
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = null;
    pollStartedAt = 0;
    pollStage = "idle";

    refreshBtn.disabled = false;
    refreshBtn.textContent = "–û–±–Ω–æ–≤–∏—Ç—å";
  }

  async function pollTick(){
    const raw = await loadStatusBox();
    const elapsed = Date.now() - pollStartedAt;

    // Stage 1: wait start (up to 10s)
    if (pollStage === "waitingStart") {
      if (isUpdating(raw)) {
        pollStage = "waitingFinish";
        return;
      }
      if (elapsed >= START_TIMEOUT_MS) {
        stopPolling();
        return;
      }
      return;
    }

    // Stage 2: wait finish
    if (pollStage === "waitingFinish") {
      if (!isUpdating(raw) && hasTime(raw)) {
        stopPolling();
        await loadGroup(currentGroup);
        await loadStatusBox();
      }
    }
  }

  async function refreshAllLive(){
    stopPolling();

    refreshBtn.disabled = true;
    refreshBtn.textContent = "‚Ä¶";

    await runTrigger();

    await loadStatusBox();

    pollStartedAt = Date.now();
    pollStage = "waitingStart";
    pollTimer = setInterval(pollTick, POLL_INTERVAL_MS);
  }

  // =======================
  // Events
  // =======================
  tab1.onclick = ()=>loadGroup(1);
  tab2.onclick = ()=>loadGroup(2);
  tab3.onclick = ()=>loadGroup(3);

  searchEl.oninput = renderFiltered;

  refreshBtn.onclick = refreshAllLive;

  columnsBtn.onclick = openModal;
  modalBackdrop.onclick = closeModalUI;
  closeModal.onclick = closeModalUI;
  cancelCols.onclick = closeModalUI;
  applyCols.onclick = applyDraft;
  selectAll.onclick = showAllCols;
  selectMin.onclick = showOnlyLabel;

  // Init
  applyTabs(1);
  loadGroup(1);
</script>

</body>
</html>
