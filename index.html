<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ITS Work Watch ‚Äî –°–ø–∏—Å–∫–∏</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --brand-blue:#0047BB;
      --brand-teal:#00C5B5;
    }
    body { -webkit-tap-highlight-color: transparent; }
    .table-scroll { -webkit-overflow-scrolling: touch; }
    thead th { position: sticky; top: 0; z-index: 30; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 h-screen overflow-hidden">

<header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-slate-200">
  <div class="max-w-6xl mx-auto px-3 sm:px-4">
    <div class="h-14 flex items-center gap-3">
      <div class="text-lg font-bold" style="color:var(--brand-blue)">
        ITS Work Watch
      </div>
      <div class="flex-1"></div>
      <div class="md:hidden text-xl">‚ò∞</div>
    </div>

    <div class="pb-3 space-y-2">
      <div class="grid grid-cols-4 gap-2">
        <button id="tab1" class="h-10 rounded-xl text-xs sm:text-sm font-semibold border">–ì—Ä—É–ø–ø–∞ 1</button>
        <button id="tab2" class="h-10 rounded-xl text-xs sm:text-sm font-semibold border">–ì—Ä—É–ø–ø–∞ 2</button>
        <button id="tab3" class="h-10 rounded-xl text-xs sm:text-sm font-semibold border">–ì—Ä—É–ø–ø–∞ 3</button>
        <button id="tab4" class="h-10 rounded-xl text-xs sm:text-sm font-semibold border">–ù–æ—á—å</button>
      </div>

      <div class="flex gap-2 items-center">
        <input
          id="search"
          type="number"
          inputmode="numeric"
          placeholder="–ü–æ–∏—Å–∫ –ø–æ ‚Ññ–º–µ—Ç–∫–∏..."
          class="min-w-0 flex-1 h-9 px-3 rounded-xl border border-slate-200 focus:ring-4 focus:ring-blue-100 text-sm"
        />
        <button id="columnsBtn" class="h-9 px-3 rounded-xl border border-slate-200 text-sm font-semibold bg-white">–ö–æ–ª–æ–Ω–∫–∏</button>
        <button id="refreshBtn" class="h-9 px-3 rounded-xl border border-slate-200 text-sm font-semibold">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>

      <div id="hint" class="hidden text-[10px] text-slate-500"></div>
      <div id="status" class="hidden rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700"></div>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-3 sm:px-4 py-3 h-[calc(100vh-16.5rem)]">
  <div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden h-full">
    <div id="tableScroll" class="table-scroll overflow-auto h-full">
      <table class="min-w-full text-sm">
        <thead id="thead" class="bg-slate-50"></thead>
        <tbody id="tbody" class="divide-y divide-slate-100"></tbody>
      </table>
    </div>
  </div>
</main>

<div id="modal" class="hidden fixed inset-0 z-50">
  <div id="modalBackdrop" class="absolute inset-0 bg-black/40"></div>
  <div class="relative mx-auto max-w-lg px-3 mt-6">
    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
      <div class="px-4 py-3 border-b border-slate-200 flex items-center gap-3">
        <div class="font-semibold">–ö–æ–ª–æ–Ω–∫–∏</div>
        <div class="flex-1"></div>
        <button id="closeModal" class="h-9 w-9 rounded-xl border border-slate-200">‚úï</button>
      </div>
      <div class="px-4 py-3">
        <div class="flex gap-2 mb-3">
          <button id="selectAll" class="h-8 px-3 rounded-lg border text-xs font-semibold">–í—Å–µ</button>
          <button id="selectMin" class="h-8 px-3 rounded-lg border text-xs font-semibold">–°–±—Ä–æ—Å</button>
        </div>
        <div id="colsList" class="max-h-[50vh] overflow-auto space-y-2"></div>
      </div>
      <div class="px-4 py-3 border-t flex items-center gap-2">
        <button id="applyCols" class="h-10 px-4 rounded-xl text-white text-sm font-semibold bg-blue-600">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <div class="flex-1"></div>
        <div class="text-xs text-slate-500" id="colsCounter"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Google Sheet
  const SHEET_ID = "1CU56AZdWC9dCvkf_z6CWMtrgfuWRCG3HYx7hp79vI_c";
  const SHEET_NAME = "–î–ª—è –ø–µ—á–∞—Ç–∏üñ®Ô∏è";
  const STATUS_SHEET_NAME = "–°–≤–æ–¥_–∂—É—Ä–Ω–∞–ª–æ–≤_–°–ü–ì+–¢–°–ë";
  const STATUS_RANGE = "Q1:R2";

  // –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –î–ò–ê–ü–ê–ó–û–ù–´
  const GROUPS = {
    1: "D2:M150",
    2: "R2:Z150",
    3: "AE2:AM150",
    4: "AR2:AZ150" 
  };

  const TRIGGER_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzU7wYhYZxJu8_QvJMq174aPZ6lPeHu5PY6jqfyGbE1QgxZv0KwFVvgsDt_A2-wXUWA/exec";
  const TRIGGER_TOKEN = "12345";
  const STATUS_COL_NAME = "–°—Ç–∞—Ç—É—Å –æ–±—Ö–æ–¥–∞";
  const STATUS_WAIT = "–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö";
  const STATUS_DONE = "–î–∞–Ω–Ω—ã–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã";

  // State
  let currentGroup = 1;
  let headers = [];
  let rows = [];
  let labelIndex = -1;
  let walkStatusIndex = -1;
  let visibleCols = new Set();
  let draftVisibleCols = new Set();

  const labelCounts = {
    1: { total: 0, done: 0 },
    2: { total: 0, done: 0 },
    3: { total: 0, done: 0 },
    4: { total: 0, done: 0 }
  };

  // UI Elements
  const tabs = [
    document.getElementById("tab1"),
    document.getElementById("tab2"),
    document.getElementById("tab3"),
    document.getElementById("tab4")
  ];
  const searchEl = document.getElementById("search");
  const refreshBtn = document.getElementById("refreshBtn");
  const columnsBtn = document.getElementById("columnsBtn");
  const thead = document.getElementById("thead");
  const tbody = document.getElementById("tbody");
  const hintEl = document.getElementById("hint");
  const tableScroll = document.getElementById("tableScroll");
  const statusEl = document.getElementById("status");
  const modal = document.getElementById("modal");
  const colsList = document.getElementById("colsList");
  const colsCounter = document.getElementById("colsCounter");

  // –§—É–Ω–∫—Ü–∏–∏
  function setStatusBoxHtml(html){
    if (!html) { statusEl.classList.add("hidden"); return; }
    statusEl.classList.remove("hidden");
    statusEl.innerHTML = html;
  }

  function setHint(text){
    if (!text) { hintEl.classList.add("hidden"); return; }
    hintEl.classList.remove("hidden");
    hintEl.textContent = text;
  }

  function norm(s){ return String(s ?? "").toLowerCase().replace(/\s/g, ""); }
  function cellText(v){ return (v === null || v === undefined) ? "" : String(v); }
  function isIntLike(s){ return /^[0-9]+$/.test(String(s).trim()); }
  function escapeHtml(str) { return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m])); }

  function updateTabsUI(){
    tabs.forEach((btn, i) => {
      const g = i + 1;
      const info = labelCounts[g];
      let name = g === 4 ? "–ù–æ—á—å" : `–ì—Ä—É–ø–ø–∞ ${g}`;
      btn.textContent = `${name} (${info.done}/${info.total})`;
      
      if(g === currentGroup){
        btn.classList.add("bg-[#0047BB]", "text-white", "border-transparent");
        btn.classList.remove("bg-white", "text-slate-900");
      } else {
        btn.classList.remove("bg-[#0047BB]", "text-white", "border-transparent");
        btn.classList.add("bg-white", "text-slate-900");
      }
    });
  }

  async function loadGroup(n){
    currentGroup = n;
    searchEl.value = "";
    tableScroll.scrollTop = 0;
    updateTabsUI();
    loadStatusBox();

    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&range=${encodeURIComponent(GROUPS[n])}&headers=1&t=${Date.now()}`;

    try{
      const res = await fetch(url);
      const text = await res.text();
      const json = JSON.parse(text.substring(47).slice(0,-2));
      const table = json.table;

      headers = table.cols.map(c => cellText(c.label || ""));
      rows = table.rows.map(r => (r.c || []).map(c => cellText(c ? c.v : ""))).filter(row => row.some(c => c.trim() !== ""));

      // –ü–æ–∏—Å–∫ –∫–æ–ª–æ–Ω–∫–∏ ‚Ññ–º–µ—Ç–∫–∏
      labelIndex = headers.findIndex(h => norm(h).includes("–º–µ—Ç–∫"));
      walkStatusIndex = headers.findIndex(h => norm(h) === norm(STATUS_COL_NAME));

      // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
      if (walkStatusIndex !== -1) {
        rows.sort((a,b) => {
          const r = (v) => {
            const s = v.trim();
            if (s === STATUS_WAIT) return 0;
            if (s === STATUS_DONE) return 1;
            return 2;
          };
          return r(a[walkStatusIndex]) - r(b[walkStatusIndex]);
        });
      }

      labelCounts[currentGroup] = {
        total: rows.filter(r => labelIndex!==-1 && isIntLike(r[labelIndex])).length,
        done: rows.filter(r => walkStatusIndex!==-1 && r[walkStatusIndex].trim() === STATUS_DONE).length
      };

      updateTabsUI();
      loadVisibleCols();
      renderTable();
    } catch (e) {
      tbody.innerHTML = `<tr><td class="p-10 text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
    }
  }

  function loadVisibleCols(){
    const key = `cols_v10_${currentGroup}_${headers.length}`;
    const saved = localStorage.getItem(key);
    if(saved) visibleCols = new Set(JSON.parse(saved));
    else visibleCols = new Set(headers.map((_,i)=>i));
    if(labelIndex !== -1) visibleCols.add(labelIndex);
  }

  function renderTable(){
    const q = searchEl.value.trim().toLowerCase();
    const filtered = rows.filter(r => !q || (labelIndex !== -1 && r[labelIndex].toLowerCase().includes(q)));
    const colIdx = headers.map((_,i)=>i).filter(i => visibleCols.has(i));

    thead.innerHTML = `<tr>${colIdx.map(i=>`<th class="px-3 py-3 text-left border-b bg-slate-100 whitespace-nowrap">${escapeHtml(headers[i]||'‚Äî')}</th>`).join('')}</tr>`;
    
    tbody.innerHTML = filtered.map(row => {
      const isDone = walkStatusIndex!==-1 && row[walkStatusIndex].trim() === STATUS_DONE;
      return `<tr class="${isDone ? 'bg-emerald-50' : ''}">
        ${colIdx.map(i => `<td class="px-3 py-3 border-b whitespace-nowrap">${escapeHtml(row[i])}</td>`).join('')}
      </tr>`;
    }).join('');
  }

  async function loadStatusBox(){
    try {
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(STATUS_SHEET_NAME)}&range=${encodeURIComponent(STATUS_RANGE)}&headers=0&t=${Date.now()}`;
      const res = await fetch(url);
      const text = await res.text();
      const json = JSON.parse(text.substring(47).slice(0,-2));
      const lines = json.table.rows.map(r => r.c.map(c => cellText(c?.v)).filter(Boolean).join(" ")).filter(Boolean);
      setStatusBoxHtml(lines.length ? `<div class="flex items-center gap-2"><div class="h-2 w-2 rounded-full bg-teal-500"></div><div>${lines.map(l=>`<div>${escapeHtml(l)}</div>`).join("")}</div></div>` : "");
    } catch { setStatusBoxHtml(""); }
  }

  // Event Listeners
  tabs.forEach((t, i) => t.onclick = () => loadGroup(i+1));
  searchEl.oninput = renderTable;
  
  columnsBtn.onclick = () => {
    draftVisibleCols = new Set(visibleCols);
    colsList.innerHTML = headers.map((h, i) => `
      <label class="flex items-center gap-3 p-2 border rounded-xl">
        <input type="checkbox" ${draftVisibleCols.has(i)?'checked':''} ${i===labelIndex?'disabled':''} onchange="updateDraft(${i}, this.checked)">
        <span class="text-sm">${escapeHtml(h || '–ö–æ–ª–æ–Ω–∫–∞ '+(i+1))}</span>
      </label>
    `).join('');
    modal.classList.remove("hidden");
  };

  window.updateDraft = (i, checked) => {
    if(checked) draftVisibleCols.add(i); else draftVisibleCols.delete(i);
    colsCounter.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${draftVisibleCols.size}`;
  };

  document.getElementById("applyCols").onclick = () => {
    visibleCols = new Set(draftVisibleCols);
    localStorage.setItem(`cols_v10_${currentGroup}_${headers.length}`, JSON.stringify(Array.from(visibleCols)));
    modal.classList.add("hidden");
    renderTable();
  };

  document.getElementById("closeModal").onclick = () => modal.classList.add("hidden");

  refreshBtn.onclick = async () => {
    refreshBtn.disabled = true; refreshBtn.textContent = "‚åõ";
    (new Image()).src = `${TRIGGER_WEBAPP_URL}?token=${TRIGGER_TOKEN}&t=${Date.now()}`;
    setTimeout(() => { loadGroup(currentGroup); refreshBtn.disabled = false; refreshBtn.textContent = "–û–±–Ω–æ–≤–∏—Ç—å"; }, 3000);
  };

  // Init
  loadGroup(1);
</script>
</body>
</html>
